---
title: "Examining Cars from *eBay Kleinanzeigen*"
output:
  html_document:
    keep_md: true
  pdf_document: default
urlcolor: blue
---
```{r include=FALSE} 
knitr::opts_chunk$set(comment = NA, warning = FALSE, message = FALSE)
library(dplyr)
library(kableExtra)
library(lubridate)
library(ggplot2)
library(magrittr)
```

## Introduction
This project examines 50,000 used car/ used car sales data points from the classifieds section of the German eBay website.  The data originates from Kaggle but has been dirtied by Dataquest for purposes of data cleaning.  A few of the dataset variables include:

* ```name```: the name of the car

* ```dateCreated```: the date the eBay listing was created

* ```nrOfPictures```: the number of pictures in the ad

* ```kilometer```: how many kilometers the car has driven

Here's sampling of the first few rows.

```{r}
setwd("/Users/roberthazell/Desktop/Dataquest/Germany-Ebay-Car-Analysis")
autos <- read.csv("autos.csv")
# use auto_info to preserve original dataset auto_info
auto_info = autos
head(auto_info)
```
## Initial Data Exploration

Taking a look at the structure:

```{r}
str(auto_info)
```
Many of these variables are factor variables though they don't need to.  Such variables include ```lastSeen```, ```dateCreated```, ```price```, and ```odometer```.

We can check if there are ```NA```s, too.  Thankfully none of the variables are null.

```{r}
sapply(auto_info,  function(x) sum(is.na(x)))
```

We can get a five-number summary of this data.

```{r}
summary(auto_info)
```

Taking a brief look, the number of pictures (```nrOfPictures```) is completely zero, so this column can be removed.

```{r}
# get the column number of that variable
pictures_col <- grep("Pictures", colnames(auto_info))
# remove the column
auto_info <- auto_info[, -pictures_col]
```

## Cleaning the data structure

Earlier it was mentioned some of the variables have improper datatypes.  Some of these variables, like ```price``` and ```odometer``` have extra characters ($ and km).  Even if no analysis is to be done on them, it's still helpful to reformat them anyway just in case.

Here's a rundown of what to transform each variable's datatype in to.

```{r}
var_transform <- data.frame(
  'Variable Name' = c('dateCrawled', 'name', 
                      'price', 'model', 'odometer', 
                      'brand', 'dateCreated', 'lastSeen'),
                            
  'Convert To' = c('Date', 'String', 'Numeric', 
                   'String', 'Integer', 'String', 'Date', 'Date'))

var_transform %>% 
  `colnames<-`(c('Variable Name', 'Convert To')) %>% 
  kable(align = rep('c',2)) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

Let's do that now in the order of the table above.

```{r}
auto_info$dateCrawled <- ymd_hms(auto_info$dateCrawled) %>% date()
auto_info$name <- as.character(auto_info$name)
# remove "$" and any commas from the price column 
auto_info$price %<>% as.character() %>% gsub(",", "", .) %>% 
  sub("\\$", "", .) %>% as.numeric()
auto_info$model <- as.character(auto_info$model)
# remove "km" and "," and make values numeric in the odometer column
auto_info$odometer %<>% as.character() %>% sub("km","", .) %>% 
  sub(",","", .) %>% as.numeric()
auto_info$brand <- as.character(auto_info$brand)
auto_info$dateCreated <- ymd_hms(auto_info$dateCreated) %>% date()
auto_info$lastSeen <- ymd_hms(auto_info$lastSeen) %>% date()
```

## Exploring Odometer and Price

We'll examine ```odometer``` and ```price``` for any patterns, beginning with ```odometer```.

```{r}
auto_info %>% 
  group_by(`Odometer Value (km)` = odometer) %>% 
  summarise(Total = length(`Odometer Value (km)`)) %>% 
  arrange(desc(`Odometer Value (km)`)) %>% 
  kable(align = rep('c',2)) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

Clearly, the majority of used cars have traveled farther.  

Let's look at price.

```{r}
price_summary <- auto_info %>% select(price) %>% 
  group_by(`Price($)`= price) %>% 
  summarise(`Total Cars` = length(`Price($)`)) 

price_summary %>% arrange(`Price($)`) %>% head() %>% 
  kable(align = rep('c',2)) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)

price_summary %>% arrange(desc(`Price($)`)) %>% 
  head() %>% kable(align = rep('c',2)) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

Amazingly, some cars are listed as \$0, though that represents only 2% of the cars.  The most expensive car is \$99,999,999! 

## Exploring Ad Dates

The ```lastSeen``` column  records the date the web crawler last saw any listing, which allows us to determine on what day a listing was removed, presumably because the car was sold.  Let's take a look and see if any patterns emerge.

```{r}
ad_timeline <- auto_info %>% 
  group_by(`Last Seen` = lastSeen) %>% 
  summarise(Total = length(`Last Seen`))

ad_timeline %>% head() %>% 
  kable(align = rep('c',2)) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

Better to make a time series plot.

```{r}
ggplot(ad_timeline) + 
  geom_line(aes(`Last Seen`, Total), col = 'steel blue') + 
  xlab("Day") + ylab("Total Ads") + 
  ggtitle("Car Listings Removed Between 3/5/16 and 4/7/16") + 
  theme(plot.title = element_text(hjust = 0.5))
```

The number of car listings taken down is roughly uniform until April 4 (the last three days of the dataset).  It's unclear what's behind this behavior but further research can be done to determine the cause of (an apparent) buying frenzy.

## Fixing Incorrect Registration Year Data

Looking back at the ```summary(auto_info)``` output, you'll see the minimum value for the ```yearOfRegistration``` column is ```1000``` and the maximum value is ```9999```, obviously incorrect data.

```{r}
summary(auto_info$yearOfRegistration)
```

Furthermore, there is mismatch between the year an eBay ad was posted and the year a car was first registered.  In other words, it's not possible for a car to be first registered after the listing was first seen.  However, this anomaly exists.

```{r}
# find latest year for car registration
auto_info %>% select(yearOfRegistration) %>% 
  filter(yearOfRegistration < 2020) %>% 
  arrange(desc(yearOfRegistration)) %>% 
  head(1)

# find latest year a car listing was made
year(auto_info$dateCreated) %>% max()
```

So the latest listing is from 2016 but the latest car registration year is 2019.  For simplicity we'll assume the earliest valid registration is somewhere in the early 20th century.  We can count the number cars with registration outside 1900-2016 and see if those rows can safely be removed, or if more custom logic is needed.

```{r}
auto_info %>% 
  filter(!between(yearOfRegistration, 1900, 2016)) %>% 
  nrow()/nrow(auto_info)
```

Car registrations outside the 1900-2016 range account for less than 4% of the complete dataset, so these can be safely removed.

```{r}
auto_info %<>% filter(between(yearOfRegistration, 1900, 2016)) 
```

## Exploring Price by Brand

Let's first look at the number of car listings by brand.

```{r}
top_listings <- auto_info %>% 
  select(brand) %>% group_by(Brand = brand) %>% 
  summarise(Total = length(Brand)) %>% 
  arrange(desc(Total))

top_listings
```

As one might guess (though it need not be the true), the highest proportion of cars are German in origin, representing four out of the top 5 brands.  The price analysis will focus on the top five brands.

```{r}
top_five_listings = head(top_listings$Brand, 5)

auto_info %>% 
  filter(brand %in% top_five_listings) %>% 
  group_by(Brand = brand) %>% 
  summarise(`Mean Price` = mean(price))
```

Mercedes has the highest mean price, but is there an outlier?  Yes.  

```{r}
top_n(auto_info, 1, auto_info$price) %>% select(price, brand)
```

The highest priced car (at \$99,999,999) belongs to this brand.  So why is ```1e08``` (\$100,000,000) shown?  This is the well known problem of precision in computer science.  Just to prove I'm not bluffing, take a look at this:

```{r}
x = 99999999
x
```

It's outside the scope of this report but you can find more info (if not familiar already with the subject) beginning [here](https://stackoverflow.com/questions/9508518/why-are-these-numbers-not-equal). 

If we remove this row, let's see how the mean prices change.

```{r}
# remove outlier
auto_info <- auto_info[-which(auto_info$price == max(auto_info$price)), ]
# find mean prices
auto_info %>% filter(brand %in% top_five_listings) %>% 
  group_by(Brand = brand) %>% 
  summarise(`Mean Price` = mean(price))
```

Now it's Audi that features the highest mean price.

## Exploring Mileage

The final variable of exploration is mileage.  Which brands have higher mileage listed, and does this correlate with price?

```{r}
auto_info %>% filter(brand %in% top_five_listings) %>% 
  group_by(Brand = brand) %>% 
  select(Brand, price, odometer) %>%
  summarise(`Mean Price` = mean(price), `Mean Mileage` = mean(odometer)) %>%
  arrange(desc(`Mean Mileage`))
```

There isn't much variability in mean mileage, but cars with higher mileage tend to be more expensive.  

## Conclusion

This project explores used car data from Germany's eBay website.  The analysis covered questions regarding:

* data structure

* most popular brands

* outliers

* price

* mileage

* car listing dates